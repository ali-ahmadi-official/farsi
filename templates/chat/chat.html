{% load tz %}
{% load static %}

<!DOCTYPE html>
<html lang="en" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css">
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
    <title>صفحه چت</title>
</head>

<body>
    <div class="black"></div>
    <div class="page-content page-container" id="page-content" style="height: 100vh;">
        <div class="padding">
            <div class="row container d-flex justify-content-center"
                style="max-width: 100%; padding: 0; margin: 0; height: 100vh;">
                <div class="col-md-6" style="max-width: 100%; height: 100vh; padding: 0;" id="reload">
                    <div class="card card-bordered"
                        style="margin: 0; height: 100vh; width: 100vw; background-color: #f9fafb !important;">
                        <div class="card-header">
                            <h4 class="card-title"><strong>هلدینگ فارسی</strong></h4>
                            <a class="btn btn-xs btn-secondary"
                                {% if user.user_type == '1' %}
                                href="{% url 'super_admin_tickets' %}"
                                {% elif user.user_type == '2' %}
                                href="{% url 'manager_tickets' %}"
                                {% else %}
                                href="{% url 'employee_tickets' %}"
                                {% endif %}
                                data-abc="true">
                                بازگشت به تیکت ها
                            </a>
                        </div>
                        <div class="no-scrollbar ps-container ps-theme-default ps-active-y" id="chat-content"
                        style="overflow-y: scroll !important; height: calc(100vh - 115.5px) !important;">
                            {% for message_by_day in messages_by_day %}
                            <div class="media media-meta-day" style="color: black;">{{ message_by_day.date }}</div>
                            {% for message in message_by_day.messages %}
                            {% if message.user in conversation.users.all %}
                            <div class="media media-chat {% if message.user != user %} media-chat-reverse {% endif %}"
                                id="{{ message.id }}">
                                <div class="media-body" style="display: flex; flex-direction: column;">
                                    <p dir="rtl" style="margin-left: 5px;">
                                        {% if user not in conversation.users.all %}
                                        {{ message.user }} :
                                        {% endif %}
                                        {{ message.body }}
                                        {% if message.user == user %}
                                        <br>
                                        {% if message.seen %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            fill="currentColor" class="bi bi-check-all" viewBox="0 0 16 16">
                                            <path
                                                d="M8.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L2.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093L8.95 4.992zm-.92 5.14.92.92a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 1 0-1.091-1.028L9.477 9.417l-.485-.486z" />
                                        </svg>
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                                            <path
                                                d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z" />
                                        </svg>
                                        {% endif %}
                                        {% endif %}
                                    </p>
                                    {% if message.file %}
                                    <div
                                        style="display: flex; justify-content: center; align-items: center; padding: 10px; border-radius: 3px; background-color: #fff;">
                                        <a href="{{ message.file.url }}" download>دانلود فایل ضمیمه</a>
                                    </div>
                                    {% endif %}
                                    <p class="meta me info" style="color: black;">
                                        <time style="background-color: #fff !important;">
                                            {{ message.created_at|localtime|time:"H:i" }}
                                        </time>
                                        {% if user.user_type == '1' or message.user == user %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            onclick="showInfo(this)" fill="currentColor" class="bi bi-three-dots"
                                            viewBox="0 0 16 16">
                                            <path
                                                d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3" />
                                        </svg>
                                        {% endif %}
                                    </p>
                                </div>
                                {% if user.user_type == '1' or message.user == user %}
                                <div id="info_{{ message.id }}" class="info-box">
                                    <div id="x">
                                        X
                                    </div>
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71z"/>
                                        </svg>

                                        {{ message_by_day.date }} {{ message.created_at|localtime|time:"H:i" }}
                                    </div>
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                                            <path
                                                d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001" />
                                        </svg>
                                        ویرایش
                                    </div>
                                    <div>
                                        <form method="post" action="{% url 'edit_chat' message.id %}" class="publisher bt-1 border-light"
                                            style="width: 100%; border-radius: 5px;">
                                            {% csrf_token %}
                                            <input class="publisher-input" type="text" name="body"
                                                value="{{ message.body }}" autocomplete="off" required autofocus>
                                            <button type="submit" class="publisher-btn text-info" data-abc="true"><i
                                                    class="fa fa-paper-plane"></i></button>
                                        </form>
                                    </div>
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                            <path
                                                d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0" />
                                        </svg>
                                        حذف
                                    </div>
                                    <div>
                                        <form method="post" action="{% url 'delete_chat' message.id %}" class="publisher bt-1 border-light"
                                            style="width: 100%; border-radius: 5px;" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <input class="publisher-input" type="text"
                                                placeholder="آیا از حذف اطمینان دارید؟" autocomplete="off" disabled>
                                            <button type="submit" class="publisher-btn text-info" data-abc="true"
                                                style="color: red !important;">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="media media-chat {% if message.user != user %} media-chat-reverse {% endif %}"
                                id="{{ message.id }}">
                                <div class="media-body" style="display: flex; flex-direction: column;">
                                    <p dir="rtl" style="margin-left: 5px; background-color: rgb(255, 38, 38) !important;">
                                        پیغام مدیر کل: {{ message.body }}
                                        {% if message.user == user %}
                                        <br>
                                        {% if message.seen %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            fill="currentColor" class="bi bi-check-all" viewBox="0 0 16 16">
                                            <path
                                                d="M8.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L2.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093L8.95 4.992zm-.92 5.14.92.92a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 1 0-1.091-1.028L9.477 9.417l-.485-.486z" />
                                        </svg>
                                        {% else %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            fill="currentColor" class="bi bi-check" viewBox="0 0 16 16">
                                            <path
                                                d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z" />
                                        </svg>
                                        {% endif %}
                                        {% endif %}
                                    </p>
                                    {% if message.file %}
                                    <div
                                        style="display: flex; justify-content: center; align-items: center; padding: 10px; border-radius: 3px; background-color: #fff;">
                                        <a href="{{ message.file.url }}" download>دانلود فایل ضمیمه</a>
                                    </div>
                                    {% endif %}
                                    <p class="meta me info" style="color: black;">
                                        <time style="background-color: #fff !important;">
                                            {{ message.created_at|localtime|time:"H:i" }}
                                        </time>
                                        {% if message.user == user %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            onclick="showInfo(this)" fill="currentColor" class="bi bi-three-dots"
                                            viewBox="0 0 16 16">
                                            <path
                                                d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3m5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3" />
                                        </svg>
                                        {% endif %}
                                    </p>
                                </div>
                                {% if message.user == user %}
                                <div id="info_{{ message.id }}" class="info-box">
                                    <div id="x">
                                        X
                                    </div>
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71z"/>
                                        </svg>

                                        {{ message_by_day.date }} {{ message.created_at|localtime|time:"H:i" }}
                                    </div>
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                                            <path
                                                d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001" />
                                        </svg>
                                        ویرایش
                                    </div>
                                    <div>
                                        <form method="post" action="{% url 'edit_chat' message.id %}" class="publisher bt-1 border-light"
                                            style="width: 100%; border-radius: 5px;">
                                            {% csrf_token %}
                                            <input class="publisher-input" type="text" name="body"
                                                value="{{ message.body }}" autocomplete="off" required autofocus>
                                            <button type="submit" class="publisher-btn text-info" data-abc="true"><i
                                                    class="fa fa-paper-plane"></i></button>
                                        </form>
                                    </div>
                                    <div>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                            <path
                                                d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0" />
                                        </svg>
                                        حذف
                                    </div>
                                    <div>
                                        <form method="post" action="{% url 'delete_chat' message.id %}" class="publisher bt-1 border-light"
                                            style="width: 100%; border-radius: 5px;" enctype="multipart/form-data">
                                            {% csrf_token %}
                                            <input class="publisher-input" type="text"
                                                placeholder="آیا از حذف اطمینان دارید؟" autocomplete="off" disabled>
                                            <button type="submit" class="publisher-btn text-info" data-abc="true"
                                                style="color: red !important;">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% endfor %}
                            {% endfor %}
                            <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px;">
                                <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
                            </div>
                            <div class="ps-scrollbar-y-rail" style="top: 0px; height: 0px; right: 2px;">
                                <div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 2px;"></div>
                            </div>
                            <div id="down" style="cursor: pointer;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                                    class="bi bi-chevron-double-down" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                        d="M1.646 6.646a.5.5 0 0 1 .708 0L8 12.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />
                                    <path fill-rule="evenodd"
                                        d="M1.646 2.646a.5.5 0 0 1 .708 0L8 8.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />
                                </svg>
                            </div>
                        </div>
                        <div id="fileNameBox"></div>
                        <form method="post" action="{% url 'add_chat' conversation.id %}" class="publisher bt-1 border-light" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input class="publisher-input" type="text" name="body" placeholder="چیزی بنویسید ...."
                                autocomplete="off" required autofocus>
                            <span class="publisher-btn file-group">
                                <i class="fa fa-paperclip file-browser"></i>
                                <input type="file" name="file" id="file-input">
                            </span>
                            <button type="submit" class="publisher-btn text-info" data-abc="true"><i
                                    class="fa fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="{% static 'js/chat.js' %}"></script>
</body>

</html>