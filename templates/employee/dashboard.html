{% extends 'base_employee_dashboard.html' %}
{% load static %}

{% block title %}
داشبورد کارمند
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>

<script src="https://unpkg.com/jalaali-js/dist/jalaali.js"></script>
<script src="https://unpkg.com/jalaali-js/dist/jalaali.min.js"></script>
{% endblock %}

{% block page1 %}
داشبورد
{% endblock %}

{% block page2 %}
کارمند
{% endblock %}

{% block content %}
<div class="row">
    {% if request.user.user_profile.status != "2" %}
    <div class="text-center mb-4">
        {% if request.user.user_profile.status == "1" %}
        <div
            style="background-color: #fff; border: 1px solid #eab308; border-radius: 0.5rem; color: #eab308; padding: 8px 32px; font-size: 0.75rem; font-weight: 700; margin-top: 40px;">
            <svg style="margin-left: 8px; margin-bottom: 5px;" xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-exclamation-triangle" viewBox="0 0 16 16">
                <path d="M2.5 15a.5.5 0 1 1 0-1h1v-1a4.5 4.5 0 0 1 2.557-4.06c.29-.139.443-.377.443-.59v-.7c0-.213-.154-.451-.443-.59A4.5 4.5 0 0 1 3.5 3V2h-1a.5.5 0 0 1 0-1h11a.5.5 0 0 1 0 1h-1v1a4.5 4.5 0 0 1-2.557 4.06c-.29.139-.443.377-.443.59v.7c0 .213.154.451.443.59A4.5 4.5 0 0 1 12.5 13v1h1a.5.5 0 0 1 0 1zm2-13v1c0 .537.12 1.045.337 1.5h6.326c.216-.455.337-.963.337-1.5V2zm3 6.35c0 .701-.478 1.236-1.011 1.492A3.5 3.5 0 0 0 4.5 13s.866-1.299 3-1.48zm1 0v3.17c2.134.181 3 1.48 3 1.48a3.5 3.5 0 0 0-1.989-3.158C8.978 9.586 8.5 9.052 8.5 8.351z"/>
            </svg>
            <span style="font-size: large;">پروفایل شما در صف بررسی است و به زودی بررسی خواهد شد.</span>
        </div>
        {% elif request.user.user_profile.status == "3" %}
        <div
            style="background-color: #fff; border: 1px solid #ef4444; border-radius: 0.5rem; color: #ef4444; padding: 8px 32px; font-size: 0.75rem; font-weight: 700; margin-top: 40px;">
            <svg style="margin-left: 8px; margin-bottom: 5px;" xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-exclamation-triangle" viewBox="0 0 16 16">
                <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
                <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
            </svg>
            <span style="font-size: large;">پروفایل شما توسط مدیر کل رد شده.</span>
        </div>
        {% else %}
        <div
            style="background-color: #fff; border: 1px solid #ef4444; border-radius: 0.5rem; color: #ef4444; padding: 8px 32px; font-size: 0.75rem; font-weight: 700; margin-top: 40px;">
            <svg style="margin-left: 8px; margin-bottom: 5px;" xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-exclamation-triangle" viewBox="0 0 16 16">
                <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
                <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
            </svg>
            <span style="font-size: large;">برای انجام فعالیت باید پروفایل خود را <a href="{% url 'employee_add_profile' %}">ایجاد کنید</a></span>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
<div class="col-12">
    {% include "includes/tables/employee/activity_table.html" with title="آخرین فعالیت ها" see_all="true" %}
</div>

<script>
function isNowInActivity(startDateStr, endDateStr, startTimeStr, endTimeStr) {
  // تبدیل تاریخ شمسی به میلادی
  const [sy, sm, sd] = startDateStr.split('/').map(Number);
  const [ey, em, ed] = endDateStr.split('/').map(Number);

  const gStart = jalaali.toGregorian(sy, sm, sd);
  const gEnd = jalaali.toGregorian(ey, em, ed);

  // ترکیب با ساعت
  const [sh, smi] = startTimeStr.split(':').map(Number);
  const [eh, emi] = endTimeStr.split(':').map(Number);

  const startDate = new Date(gStart.gy, gStart.gm - 1, gStart.gd, sh, smi);
  const endDate = new Date(gEnd.gy, gEnd.gm - 1, gEnd.gd, eh, emi);

  const now = new Date();

  return now >= startDate && now <= endDate;
}

// بررسی همه فعالیت‌ها
document.querySelectorAll('.activity-data').forEach(el => {
  const startDate = el.dataset.startDate;
  const endDate = el.dataset.endDate;
  const startTime = el.dataset.startTime;
  const endTime = el.dataset.endTime;

  const isActive = isNowInActivity(startDate, endDate, startTime, endTime);

  const trueLink = el.querySelector('a.true');
  const falseLink = el.querySelector('a.false');

  if (isActive) {
    trueLink.style.display = 'inline';
  } else {
    falseLink.style.display = 'inline';
  }
});
</script>
{% endblock %}